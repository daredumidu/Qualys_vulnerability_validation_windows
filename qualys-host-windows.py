import sys
sys.path.append(r'C:\programs\qualys\password')
from password import *

import requests
import re
import os
import csv

base_url = "https://qualysapi.qualys.eu/qps/rest/2.0/search/am/hostasset"
headers = {'Content-Type': 'text/xml'}

# - - - - - - - - - - - - - - - - - - - - 

f = open('windows.txt', 'r')
f1 = f.readlines()
f.close()

# windows uses netbios name.
line1 = """<?xml version='1.0' encoding='utf-8'?><ServiceRequest><preferences><limitResults>150</limitResults></preferences><filters><Criteria field="netbiosName" operator="CONTAINS">"""
line3 = """</Criteria></filters></ServiceRequest>"""

g = open ("data.csv","w+")

for line in f1:
    line = line.rstrip()
    print (line)

    payload = (line1 + line + line3)
    #print (payload)

    # - - - - - - - - - - - - - - - - - - - - 

    file = open("./temp/%s.txt" % line, 'w') 
    #print (file)
    
    # -- post request --
    rpost = requests.post(base_url, auth=(un, pw), headers=headers, data=payload).text

    #print (rpost)
    file.write(rpost)
    file.close()

    # - - - - - - - - - - - - - - - - - - - - 

    f2 = open("./temp/%s.txt" % line, 'r')
    for line4 in f2.readlines():
        if re.search('<qid>34011', line4, re.I):        # change the QID need to verify
            data1 = "still vulnerable"
            print (data1)
            
            g.write("%s,%s \n" % (line, data1))
